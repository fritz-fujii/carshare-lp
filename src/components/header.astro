---
import { Icon } from "astro-icon/components";
import type { NavItem } from "~/types";

/* ─── ナビ項目 ─── ＊Features を除外 */
const navItems: Array<NavItem> = [
  { title: "Compatibility", url: "#compatibility" },
  { title: "Showcase",      url: "#showcase" },
];

const isEN = Astro.url.pathname.startsWith("/en");
const langItem: NavItem = isEN
  ? { title: "JP", url: "/" }
  : { title: "EN", url: "/en/" };

const menuItems = [...navItems, langItem];
---

<header
  id="page-header"
  class="absolute bottom-0 z-20 flex w-full items-center justify-between
         border-b border-transparent px-8 py-4 text-white"
>
  <!-- ★ ロゴ部分をシンプルなテキストリンクに変更 -->
  <a class="text-lg font-semibold hover:underline" href={isEN ? "/en/" : "/"}>
    IS250C Car Share
  </a>

  <!-- PC ナビ -->
  <nav class="hidden sm:block">
    <ul class="flex items-center gap-6">
      {
        menuItems.map(({ title, url }) => (
          <li><a class="text-sm hover:underline" href={url}>{title}</a></li>
        ))
      }
    </ul>
  </nav>

  <!-- モバイルハンバーガー -->
  <button id="open-nav-button" type="button" class="btn sm:hidden" aria-label="Navigation">
    <Icon name="mdi:menu" class="size-8" />
  </button>

  <!-- モバイルメニュー -->
  <div id="menu-modal" class="modal hidden" aria-hidden="true">
    <div class="fixed inset-0 bg-default px-8 py-4 text-default">
      <div class="space-y-4" role="dialog" aria-modal="true">
        <header class="text-right">
          <button id="close-nav-button" type="button" class="btn" aria-label="Close navigation">
            <Icon name="mdi:close" class="size-8" />
          </button>
        </header>
        <nav>
          <ul class="flex flex-col">
            {
              menuItems.map(({ title, url }) => (
                <li><a class="block py-4 text-center text-xl" href={url}>{title}</a></li>
              ))
            }
          </ul>
        </nav>
      </div>
    </div>
  </div>
</header>

<script>
  import MicroModal from "micromodal";
  import invariant from "tiny-invariant";

  const menuModalId = "menu-modal";
  const header = document.querySelector("#page-header");
  const page   = document.documentElement;
  const menu   = document.querySelector(`#${menuModalId} ul`);
  const openNavButton  = document.querySelector("#open-nav-button");
  const closeNavButton = document.querySelector("#close-nav-button");

  invariant(header && menu && openNavButton && closeNavButton, "header nav elements missing");

  openNavButton.addEventListener("click", () => MicroModal.show(menuModalId, { disableScroll: true }));
  closeNavButton.addEventListener("click", () => MicroModal.close(menuModalId));

  document.addEventListener("scroll", () => {
    const threshold = page.clientHeight - page.scrollTop - header.offsetHeight;
    header.classList.toggle("fixed-header", threshold < 0);
  });

  menu.addEventListener("click", e => {
    if ((e.target).tagName === "A") MicroModal.close(menuModalId);
  });
</script>

<noscript>
  <style>#open-nav-button { display: none; }</style>
</noscript>

<style>
  .fixed-header {@apply fixed top-0 bottom-auto border-default bg-default text-default;}
  .modal.is-open {@apply block;}
</style>
